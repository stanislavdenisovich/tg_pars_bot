import os
import telebot
from openai import OpenAI
import json
from datetime import datetime
import math

# =============================
#  ENV VARIABLES
# =============================
TG_BOT_TOKEN = os.getenv("TG_BOT_TOKEN")
OPENAI_KEY = os.getenv("OPENAI_API_KEY")

if not TG_BOT_TOKEN:
    raise RuntimeError("TG_BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ Railway ‚Üí Variables")
if not OPENAI_KEY:
    raise RuntimeError("OPENAI_API_KEY –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ Railway ‚Üí Variables")

bot = telebot.TeleBot(TG_BOT_TOKEN, parse_mode="HTML")
client = OpenAI(api_key=OPENAI_KEY)


# =============================
# /start
# =============================
@bot.message_handler(commands=["start"])
def start(msg):
    bot.send_message(
        msg.chat.id,
        "üî• –ù–∞–ø–∏—à–∏ —Å–≤–æ—é –∏–¥–µ—é —Å—Ç–∞—Ä—Ç–∞–ø–∞ –≤ –ª—é–±–æ–º —Ñ–æ—Ä–º–∞—Ç–µ ‚Äî –ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç–æ–º.\n"
        "–Ø —Å–∞–º –∏–∑–≤–ª–µ–∫—É –∫–ª—é—á–µ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏ –æ—Ü–µ–Ω—é –µ—ë –ø–æ —Ñ–æ—Ä–º—É–ª–µ Score."
    )


# =============================
# ChatGPT ‚Äî RICE+ –∞–Ω–∞–ª–∏–∑ –±–µ–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
# =============================
def ask_chatgpt(idea_text):
    """
    GPT —Å–∞–º –∏–∑–≤–ª–µ–∫–∞–µ—Ç:
    - –ø—Ä–æ–±–ª–µ–º—É
    - –¶–ê
    - —Ä–∞–∑–º–µ—Ä –∞—É–¥–∏—Ç–æ—Ä–∏–∏
    - –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
    - —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å
    - —Å–ª–æ–∂–Ω–æ—Å—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
    –ò –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —á–∏—Å—Ç—ã–π JSON —Å 5 –º–µ—Ç—Ä–∏–∫–∞–º–∏.
    """

    rules = """
–¢—ã ‚Äî –≤–µ–¥—É—â–∏–π –ø—Ä–æ–¥—É–∫—Ç–æ–≤—ã–π –∞–Ω–∞–ª–∏—Ç–∏–∫ —É—Ä–æ–≤–Ω—è Head of Product, —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Å—Ç–∞—Ä—Ç–∞–ø–∞–º, —Ä—ã–Ω–∫–∞–º –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–π –ê–∑–∏–∏ –∏ –æ—Å–æ–±–µ–Ω–Ω–æ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞. 
–¢–≤–æ—è –∑–∞–¥–∞—á–∞: –∏–∑ –ª—é–±–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ (–¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω –Ω–µ–ø–æ–ª–Ω—ã–π, –ø—É—Ç–∞–Ω—ã–π, —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π, –±–µ–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã) –∏–∑–≤–ª–µ—á—å –º–∞–∫—Å–∏–º—É–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ 
–∏ –≤—ã–≤–µ—Å—Ç–∏ 5 —á–∏—Å–ª–æ–≤—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–æ –º–æ–¥–µ–ª–∏ RICE+Competition.

–¢–´ –û–ë–Ø–ó–ê–ù –£–ß–ò–¢–´–í–ê–¢–¨ –í–°–ï –§–ê–ö–¢–û–†–´, –£–ö–ê–ó–ê–ù–ù–´–ï –ù–ò–ñ–ï. –ù–ï –ü–†–û–ü–£–°–ö–ê–ô –ù–ò –û–î–ò–ù.

----------------------------------------------------------------------
–ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–†–ò–ù–¶–ò–ü–´ –ê–ù–ê–õ–ò–ó–ê
----------------------------------------------------------------------
1) –í—Å–µ–≥–¥–∞ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ä—ã–Ω–æ–∫ —Å—Ç—Ä–æ–≥–æ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞.
   ‚Äî –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω: 19 –º–ª–Ω  
   ‚Äî –ê–∫—Ç–∏–≤–Ω—ã–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏: 12 –º–ª–Ω  
   ‚Äî –ê–ª–º–∞—Ç—ã: 2 –º–ª–Ω (–≥–ª–∞–≤–Ω—ã–π —Ü–∏—Ñ—Ä–æ–≤–æ–π —Ö–∞–±)  
   ‚Äî –û—Å—Ç–∞–ª—å–Ω—ã–µ –≥–æ—Ä–æ–¥–∞ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –º–µ–Ω–µ–µ —Ü–∏—Ñ—Ä–æ–≤–∏–∑–∏—Ä–æ–≤–∞–Ω—ã.  

2) –£—á–∏—Ç—ã–≤–∞–π –≤—Å–µ —Å–µ–≥–º–µ–Ω—Ç—ã:
   ‚Ä¢ B2C
   ‚Ä¢ B2B
   ‚Ä¢ SMB / MSME
   ‚Ä¢ enterprise
   ‚Ä¢ –≥–æ—Å—É—Å–ª—É–≥–∏
   ‚Ä¢ —Ñ—Ä–∏–ª–∞–Ω—Å–µ—Ä—ã / —Å–∞–º–æ–∑–∞–Ω—è—Ç—ã–µ
   ‚Ä¢ —à–∫–æ–ª—å–Ω–∏–∫–∏ / —Å—Ç—É–¥–µ–Ω—Ç—ã / —Ä–æ–¥–∏—Ç–µ–ª–∏
   ‚Ä¢ –º–∏–≥—Ä–∞–Ω—Ç—ã
   ‚Ä¢ –¥–∏–∞—Å–ø–æ—Ä—ã
   ‚Ä¢ rural vs urban users

3) –£—á–∏—Ç—ã–≤–∞–π —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å:
   ‚Ä¢ –Ω–∏–∑–∫–∞—è tolerance –∫ —Å–ª–æ–∂–Ω—ã–º –ø—Ä–æ–¥—É–∫—Ç–∞–º  
   ‚Ä¢ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ª—é–±–∏—Ç –¥–æ–ª–≥–æ —Ä–∞–∑–±–∏—Ä–∞—Ç—å—Å—è  
   ‚Ä¢ –ø–æ–ø—É–ª—è—Ä–Ω—ã –≥–æ—Ç–æ–≤—ã–µ —Å–µ—Ä–≤–∏—Å—ã ¬´–≤—Å—ë –≤ –æ–¥–Ω–æ–º¬ª (Kaspi, Choco, –Ø–Ω–¥–µ–∫—Å)  
   ‚Ä¢ —Å–∏–ª—å–Ω—ã–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –º–æ–Ω–æ–ø–æ–ª–∏–∏ –ø–æ–¥–∞–≤–ª—è—é—Ç –Ω–æ–≤—ã–µ –∏–¥–µ–∏  
   ‚Ä¢ –±–æ–ª—å—à–∞—è —á–∞—Å—Ç—å —Ç—Ä–∞—Ñ–∏–∫–∞ ‚Äî –º–æ–±–∏–ª—å–Ω–∞—è  
   ‚Ä¢ UX –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∫—Ä–∞–π–Ω–µ –ø—Ä–æ—Å—Ç—ã–º  

4) –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –≤ –∏–¥–µ–µ –º–∞–ª–æ ‚Äî –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–π –∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω–æ.

5) –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –≤—ã—Ö–æ–¥–∏ –∑–∞ —Ä–∞–º–∫–∏ —Ä—ã–Ω–∫–∞ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞ ‚Äî —ç—Ç–æ –º–∞–ª–µ–Ω—å–∫–∏–π —Ä—ã–Ω–æ–∫, –Ω–µ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–π –¥–æ –º–∏–ª–ª–∏–æ–Ω–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–µ–∑ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤.

----------------------------------------------------------------------
–û–¶–ï–ù–ö–ê RICE+COMPETITION (–ø–æ–¥—Ä–æ–±–Ω–µ–π—à–∏–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏)
----------------------------------------------------------------------

######################################################################
1) REACH (0..100000)
######################################################################
Reach = –æ—Ü–µ–Ω–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ª—é–¥–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç —Ä–µ–∞–ª—å–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –ø—Ä–æ–¥—É–∫—Ç–æ–º –≤ —Ç–µ—á–µ–Ω–∏–µ 30 –¥–Ω–µ–π.

–£—á–∏—Ç—ã–≤–∞–π:
‚Ä¢ —Ä–∞–∑–º–µ—Ä –¶–ê, —É–ø–æ–º—è–Ω—É—Ç–æ–π –≤ –∏–¥–µ–µ  
‚Ä¢ —Ñ–∏–ª—å—Ç—Ä ¬´—Ä–µ–∞–ª—å–Ω–æ –¥–æ—Å—Ç–∏–∂–∏–º—ã—Ö¬ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π  
‚Ä¢ –≥–µ–æ–≥—Ä–∞—Ñ–∏—é (–ê–ª–º–∞—Ç—ã >> –ê—Å—Ç–∞–Ω–∞ >> –≥–æ—Ä–æ–¥–∞-–º–∏–ª–ª–∏–æ–Ω–Ω–∏–∫–∏ >> —Ä–µ–≥–∏–æ–Ω—ã)  
‚Ä¢ —É—Ä–æ–≤–µ–Ω—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–¥–æ—Å—Ç—É–ø–∞  
‚Ä¢ –ø–ª–∞—Ç—ë–∂–µ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –∞—É–¥–∏—Ç–æ—Ä–∏–∏  
‚Ä¢ —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—é —Ä—ã–Ω–∫–∞  
‚Ä¢ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ digital adoption  
‚Ä¢ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã  
‚Ä¢ —Å–∫–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Ä–µ–∞–ª—å–Ω–æ –±—É–¥—É—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å—Å—è 

–ì—Ä–∞–Ω–∏—Ü—ã:
‚Ä¢ 0‚Äì1000 ‚Üí —É–ª—å—Ç—Ä–∞-–Ω–∏—à–∞ (—é—Ä–∏—Å—Ç—ã, —Ä–µ–¥–∫–∏–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏, B2B —Å–µ–≥–º–µ–Ω—Ç—ã, Rare use-case)
‚Ä¢ 1k‚Äì10k ‚Üí –Ω–∏—à–∞ –ê–ª–º–∞—Ç—ã
‚Ä¢ 10k‚Äì30k ‚Üí –±–æ–ª—å—à–∞—è –Ω–∏—à–∞ –ê–ª–º–∞—Ç—ã –∏–ª–∏ –º–∞–ª–∞—è –Ω–∏—à–∞ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞
‚Ä¢ 30k‚Äì60k ‚Üí –∑–∞–º–µ—Ç–Ω—ã–π —Ä—ã–Ω–æ–∫ –ø–æ —Å—Ç—Ä–∞–Ω–µ
‚Ä¢ 60k‚Äì100k ‚Üí –º–∞—Å—Å–æ–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç –≤ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–µ

–ï—Å–ª–∏ –∏–¥–µ—è ¬´–¥–ª—è –≤—Å–µ—Ö¬ª ‚Äî –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–π —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å—é (–Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —Å—Ç–∞–≤—å 200k, 500k –∏ —Ç.–ø.).

######################################################################
2) IMPACT (1..5)
######################################################################
Impact = —Å–∏–ª–∞ —ç—Ñ—Ñ–µ–∫—Ç–∞ –Ω–∞ –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è:
1 ‚Üí –ª—ë–≥–∫–æ–µ —É–¥–æ–±—Å—Ç–≤–æ, nice-to-have  
2 ‚Üí –æ—â—É—Ç–∏–º–æ–µ —É–¥–æ–±—Å—Ç–≤–æ, –Ω–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ–µ  
3 ‚Üí –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –≤–∞–∂–Ω—É—é, –Ω–æ –Ω–µ –æ—Å—Ç—Ä—É—é –±–æ–ª—å  
4 ‚Üí —Ä–µ—à–∞–µ—Ç –∫—Ä–∏—Ç–∏—á–Ω—É—é –ø—Ä–æ–±–ª–µ–º—É, —ç–∫–æ–Ω–æ–º–∏—Ç –¥–µ–Ω—å–≥–∏/–≤—Ä–µ–º—è, –≤—ã—Å–æ–∫–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å  
5 ‚Üí ¬´game changer¬ª ‚Äî —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ–≤–µ–¥–µ–Ω–∏—è, –æ–≥—Ä–æ–º–Ω–∞—è –ø–æ–ª—å–∑–∞, —É–±–∏—Ä–∞–µ—Ç –±–æ–ª—å –ø–æ–ª–Ω–æ—Å—Ç—å—é  

–£—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è:
‚Ä¢ —ç–∫–æ–Ω–æ–º–∏—è –≤—Ä–µ–º–µ–Ω–∏  
‚Ä¢ —ç–∫–æ–Ω–æ–º–∏—è –¥–µ–Ω–µ–≥  
‚Ä¢ —É–º–µ–Ω—å—à–µ–Ω–∏–µ —Ä–∏—Å–∫–∞  
‚Ä¢ —É—Å–∫–æ—Ä–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤  
‚Ä¢ –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å –±–æ–ª–∏  
‚Ä¢ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–∞–∫—Ç–æ—Ä (–Ω–µ—Ä–≤—ã, —Å—Ç—Ä–µ—Å—Å, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)  
‚Ä¢ –Ω–∞—Å–∫–æ–ª—å–∫–æ –±–æ–ª—å –ª–æ–∫–∞–ª—å–Ω–∞/–ø–æ–≤—Å–µ–º–µ—Å—Ç–Ω–∞  
‚Ä¢ –Ω–∞—Å–∫–æ–ª—å–∫–æ –∏–¥–µ—è –∑–∞–º–µ–Ω—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã  

######################################################################
3) CONFIDENCE (0..1)
######################################################################
Confidence = —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ —Ä–µ–∞–ª–∏–∑—É–µ–º–æ—Å—Ç–∏ –∏–¥–µ–∏ –∏ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ —Å–ø—Ä–æ—Å–∞.

–û—Ü–µ–Ω–∏–≤–∞–π –ø–æ 3 –±–ª–æ–∫–∞–º (–∫–∞–∂–¥—ã–π –≤–µ—Å–∏—Ç 1/3):

A) –ß—ë—Ç–∫–æ—Å—Ç—å –∏–¥–µ–∏:
   ‚Äî –ø–æ–Ω—è—Ç–Ω–∞ –ª–∏ –ø—Ä–æ–±–ª–µ–º–∞  
   ‚Äî —è—Å–Ω–æ –ª–∏ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞–Ω–∞ –¶–ê  
   ‚Äî –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã –ª–∏ –º–µ—Ö–∞–Ω–∏–∫–∏  

B) –†—ã–Ω–æ—á–Ω–∞—è —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å:
   ‚Äî –µ—Å—Ç—å –ª–∏ –∞–Ω–∞–ª–æ–≥–∏ (–ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–ª–∏ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ)  
   ‚Äî –µ—Å—Ç—å –ª–∏ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ —Å–ø—Ä–æ—Å–∞  
   ‚Äî –≤–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –ª–∏ –∏–¥–µ—è –≤ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –∫–∞–∑–∞—Ö—Å—Ç–∞–Ω—Ü–µ–≤  

C) –†–µ–∞–ª–∏–∑—É–µ–º–æ—Å—Ç—å:
   ‚Äî —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ –ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ  
   ‚Äî –ø–æ–Ω—è—Ç–µ–Ω –ª–∏ –ø—É—Ç—å –∫ MVP  
   ‚Äî –Ω–µ—Ç –ª–∏ —Ä–µ–≥—É–ª—è—Ç–æ—Ä–Ω—ã—Ö –±–∞—Ä—å–µ—Ä–æ–≤  

–®–∫–∞–ª–∞:
‚Ä¢ 0.1‚Äì0.3 ‚Üí –∏–¥–µ—è —Å—ã—Ä–∞—è, –º–Ω–æ–≥–æ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–≥–æ  
‚Ä¢ 0.4‚Äì0.6 ‚Üí –∏–¥–µ—è –ª–æ–≥–∏—á–Ω–∞—è, –Ω–æ –±–µ–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π  
‚Ä¢ 0.7‚Äì0.9 ‚Üí –≤—ã—Å–æ–∫–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å, —Ä—ã–Ω–æ–∫ –ø–æ–Ω—è—Ç–Ω—ã–π  
‚Ä¢ 1.0 ‚Üí –ø–æ—á—Ç–∏ –Ω–µ–¥–æ—Å—Ç–∏–∂–∏–º–æ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∏–¥–µ—è —Ç—Ä–∏–≤–∏–∞–ª—å–Ω–∞—è —Ç–∏–ø–∞ ¬´–±–æ—Ç –¥–ª—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π¬ª)

######################################################################
4) EFFORT (1..10)
######################################################################
Effort = —Å–ª–æ–∂–Ω–æ—Å—Ç—å MVP —Å —É—á—ë—Ç–æ–º —Ä–µ–∞–ª–∏–π IT –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞:

–®–∫–∞–ª–∞:
1‚Äì2 ‚Üí Telegram-–±–æ—Ç, —Ñ–æ—Ä–º–∞, –ª–µ–Ω–¥–∏–Ω–≥  
3‚Äì4 ‚Üí –≤–µ–±-–ø—Ä–æ–¥—É–∫—Ç, –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è, –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö, 1‚Äì2 –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏  
5‚Äì6 ‚Üí –º–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, —Å–ª–æ–∂–Ω—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã, –ø–ª–∞—Ç–µ–∂–∏, –±–∞–ª–∞–Ω—Å, –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç  
7‚Äì8 ‚Üí real-time —Å–µ—Ä–≤–∏—Å—ã, –∫–∞—Ä—Ç—ã, –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è, —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞, –∞–ª–≥–æ—Ä–∏—Ç–º—ã, ML  
9‚Äì10 ‚Üí R&D, –≥–æ—Å–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏, –∫–∞—Å—Å–æ–≤—ã–µ —Å–∏—Å—Ç–µ–º—ã, high-load, –∫–æ–º–ø–ª–∞–µ–Ω—Å, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å  

–£—á–∏—Ç—ã–≤–∞–π:
‚Ä¢ —Å–ª–æ–∂–Ω–æ—Å—Ç—å —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏  
‚Ä¢ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–µ  
‚Ä¢ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤ –≤ –†–ö  
‚Ä¢ —Å–ª–æ–∂–Ω–æ—Å—Ç—å –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è  
‚Ä¢ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Kaspi, 1C, ERP, –ø–ª–∞—Ç–µ–∂–∞–º–∏, –ª–æ–≥–∏—Å—Ç–∏–∫–æ–π  
‚Ä¢ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ —Ä–∏—Å–∫–∏  

######################################################################
5) COMPETITION (1..10)
######################################################################
Competition = –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å —Ä—ã–Ω–∫–∞.

–ê–ª–≥–æ—Ä–∏—Ç–º:
1) –ï—Å–ª–∏ –∏–¥–µ—è —Ö–æ—Ç—å –∫–∞–∫-—Ç–æ –ø–æ—Ö–æ–∂–∞ –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–µ—Ä–≤–∏—Å—ã Kaspi/Choco/Yandex ‚Üí –º–∏–Ω–∏–º—É–º 8‚Äì10.  
2) –ï—Å–ª–∏ –Ω–∏—à–∞ –æ—á–µ–≤–∏–¥–Ω–∞—è (–¥–æ—Å—Ç–∞–≤–∫–∞, –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å, —É—Å–ª—É–≥–∏, —Ñ–∏–Ω—Ç–µ—Ö, –æ–±—É—á–µ–Ω–∏–µ, –∞—Ä–µ–Ω–¥–∞) ‚Üí 6‚Äì8.  
3) –ï—Å–ª–∏ –Ω–∏—à–∞ –Ω–æ–≤–∞—è, –Ω–µ—Ç –ø—Ä—è–º—ã—Ö –∏–≥—Ä–æ–∫–æ–≤ ‚Üí 2‚Äì4.  
4) –ï—Å–ª–∏ –∏–¥–µ—è –∏–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω–∞—è, –Ω–æ —Ä—ã–Ω–æ–∫ –Ω–µ–ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–π ‚Üí 3‚Äì5.  
5) –ï—Å–ª–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã –≥–ª–æ–±–∞–ª—å–Ω—ã–µ, –Ω–æ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –º–∞–ª–æ ‚Üí 4‚Äì6.  

–®–∫–∞–ª–∞:
1‚Äì2 ‚Üí –≥–æ–ª—É–±–æ–π –æ–∫–µ–∞–Ω  
3‚Äì5 ‚Üí —É–º–µ—Ä–µ–Ω–Ω–∞—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è  
6‚Äì8 ‚Üí –≥–æ—Ä—è—á–∏–π —Ä—ã–Ω–æ–∫  
9‚Äì10 ‚Üí –º–æ–Ω–æ–ø–æ–ª–∏–∏ (Kaspi, Choco, –Ø–Ω–¥–µ–∫—Å, Glovo)

----------------------------------------------------------------------   
–§–ò–ù–ê–õ–¨–ù–û–ï –¢–†–ï–ë–û–í–ê–ù–ò–ï
----------------------------------------------------------------------
–í–µ—Ä–Ω–∏ —Å—Ç—Ä–æ–≥–æ JSON –±–µ–∑ –∫–∞–∫–æ–≥–æ-–ª–∏–±–æ —Ç–µ–∫—Å—Ç–∞:

{
  "reach": <int>,
  "impact": <int>,
  "confidence": <float>,
  "effort": <int>,
  "competition": <int>
}
"""

    user_data = f"–ò–¥–µ—è: {idea_text}\n\n–í—ã–≤–µ–¥–∏ JSON —Å—Ç—Ä–æ–≥–æ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞."

    response = client.chat.completions.create(
        model="gpt-4o-mini",
        temperature=0.1,
        messages=[
            {"role": "system", "content": rules},
            {"role": "user", "content": user_data}
        ]
    )

    raw = response.choices[0].message.content

    # –ü–∞—Ä—Å–∏–º JSON
    try:
        data = json.loads(raw)
    except:
        import re
        m = re.search(r"\{[\s\S]*\}", raw)
        if not m:
            raise RuntimeError("GPT –≤–µ—Ä–Ω—É–ª –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π JSON:\n" + raw)
        data = json.loads(m.group(0))

    # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è + —Ç–∏–ø—ã
    def clamp_int(v, lo, hi):
        try: v = int(round(float(v)))
        except: v = lo
        return max(lo, min(hi, v))

    def clamp_float(v, lo, hi, ndigits=2):
        try: v = float(v)
        except: v = lo
        return round(max(lo, min(hi, v)), ndigits)

    return {
        "reach": clamp_int(data.get("reach", 0), 0, 100000),
        "impact": clamp_int(data.get("impact", 3), 1, 5),
        "confidence": clamp_float(data.get("confidence", 0.5), 0, 1),
        "effort": clamp_int(data.get("effort", 5), 1, 10),
        "competition": clamp_int(data.get("competition", 5), 1, 10),
    }


# =============================
# SCORE formula
# =============================
def compute_score(R, I, C, E, K, alpha=0.65, beta=1.2, gamma=0.7, delta=1.8, etha=1.5):

    # ---- 1. –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è reach ----
    R_norm = math.log(1 + max(0, R)) / math.log(100000)

    # ---- 2. –í–∑–≤–µ—à–∏–≤–∞–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ ----
    I_w = I ** beta
    C_w = C ** gamma
    E_w = E ** delta
    K_w = K ** etha

    raw = (R_norm * I_w * C_w) / (E_w * K_w)

    # ---- 3. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –≤–æ–∑–º–æ–∂–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ ----
    R_max = 1
    I_max = 5 ** beta
    C_max = 1 ** gamma
    E_min = 1 ** delta
    K_min = 1 ** etha

    raw_max = (R_max * I_max * C_max) / (E_min * K_min)

    # ---- 4. –ù–æ—Ä–º–∏—Ä–æ–≤–∫–∞ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω 0..1 ----
    norm = raw / raw_max
    norm = max(0, min(1, norm))

    # ---- 5. –õ—ë–≥–∫–∞—è S-—Ñ—É–Ω–∫—Ü–∏—è: —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –Ω–∏–∑ + —Å–≥–ª–∞–∂–∏–≤–∞–µ–º –ø–∏–∫ ----
    score = norm ** 0.55      # –∫–ª—é—á–µ–≤–æ–π –ø–∞—Ä–∞–º–µ—Ç—Ä!

    # ---- 6. –ü—Ä–∏–≤–æ–¥–∏–º –∫ 1%..100% ----
    score = 0.01 + score * 0.99

    return f"{score * 100:.1f}%"

# =============================
# SAVE
# =============================
def save_result(user_id, idea, params, score):
    with open("results.txt", "a", encoding="utf-8") as f:
        f.write("\n============================\n")
        f.write(f"–î–∞—Ç–∞: {datetime.now()}\n")
        f.write(f"User ID: {user_id}\n")
        f.write(f"–ò–¥–µ—è:\n{idea}\n\n")
        f.write("RICE+ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:\n")
        f.write(json.dumps(params, ensure_ascii=False, indent=2))
        f.write(f"\nScore: {score}\n")
        f.write("============================\n")

def generate_advice(idea, params):
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–æ—Ä–æ—Ç–∫–æ–µ, —á–µ–ª–æ–≤–µ—á–µ—Å–∫–æ–µ, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –∏–¥–µ–∏.
    """

    prompt = f"""
–¢—ã ‚Äî –æ–ø—ã—Ç–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç–æ–≤—ã–π –∞–Ω–∞–ª–∏—Ç–∏–∫ –∏–∑ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞. 
–ü–∏—à–∏ –∫—Ä–∞—Ç–∫–æ, –ø–æ –¥–µ–ª—É –∏ –ø—Ä–æ—Å—Ç—ã–º —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–º —è–∑—ã–∫–æ–º. 
–ö–∞–∂–¥—ã–π –∞–±–∑–∞—Ü ‚Äî 1‚Äì2 –∫–æ—Ä–æ—Ç–∫–∏—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –Ω–µ –±–æ–ª—å—à–µ. 
–ù–µ –ª–µ–π –≤–æ–¥—É, –Ω–µ –æ–±—ä—è—Å–Ω—è–π –æ—á–µ–≤–∏–¥–Ω–æ–µ, –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π —Å–ª–æ–∂–Ω—ã–µ —Å–ª–æ–≤–∞.

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–µ–∫—Å—Ç–∞:
1) –û—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–æ –ø–µ—Ä–µ—Å–∫–∞–∂–∏ –∏–¥–µ—é (–æ–¥–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ).
2) –ö–æ—Ä–æ—Ç–∫–∏–π –≤—ã–≤–æ–¥ –æ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–µ (–º–∞–∫—Å–∏–º—É–º 2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è).
3) –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã ‚Äî –æ–¥–∏–Ω –º–∏–Ω–∏-–∞–±–∑–∞—Ü.
4) –°–ª–∞–±—ã–µ –º–µ—Å—Ç–∞ ‚Äî –æ–¥–∏–Ω –º–∏–Ω–∏-–∞–±–∑–∞—Ü.
5) –ß—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ ‚Äî –æ–¥–∏–Ω –º–∏–Ω–∏-–∞–±–∑–∞—Ü —Å –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫–æ–π.
6) –ü–∏—à–∏ —Ç–æ–ª—å–∫–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º.
7) –ù–µ —É–ø–æ–º–∏–Ω–∞–π RICE, –±–∞–ª–ª—ã –∏ –æ—Ü–µ–Ω–∫–∏.

–ò—Å–ø–æ–ª—å–∑—É–π –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –≤—ã–≤–æ–¥–æ–≤:
Reach: {params['reach']}
Impact: {params['impact']}
Confidence: {params['confidence']}
Effort: {params['effort']}
Competition: {params['competition']}

–ò–¥–µ—è:
\"\"\"{idea}\"\"\"

–í—ã–≤–µ–¥–∏ —Ç–æ–ª—å–∫–æ —á–∏—Å—Ç—ã–π —Ç–µ–∫—Å—Ç, –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —ë–º–∫–æ.
"""

    response = client.chat.completions.create(
        model="gpt-4o-mini",
        temperature=0.6,
        messages=[
            {"role": "user", "content": prompt}
        ]
    )

    return response.choices[0].message.content.strip()
# =============================
# MAIN HANDLER (–ü—Ä–æ—Å—Ç–æ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∏–¥–µ—é)
# =============================
@bot.message_handler(func=lambda m: True)
def handle_idea(msg):
    user = msg.from_user.id
    idea = msg.text

    bot.send_message(msg.chat.id, "‚úÖ –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Ç–≤–æ—é –∏–¥–µ—é...")

    # 1) –°—á–∏—Ç–∞–µ–º RICE+
    params = ask_chatgpt(idea)
    score = compute_score(
        R=params["reach"],
        I=params["impact"],
        C=params["confidence"],
        E=params["effort"],
        K=params["competition"]
    )

    # 2) –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ñ–∞–π–ª
    save_result(user, idea, params, score)

    # 3) –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —É ChatGPT –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∏ —Å–æ–≤–µ—Ç—ã
    advice = generate_advice(idea, params)

    # 4) –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ–ª–æ–≤–µ–∫—É –∏—Ç–æ–≥
    result_text = f"""
<b>üîç –ê–Ω–∞–ª–∏–∑ —Ç–≤–æ–µ–π –∏–¥–µ–∏</b>

<b>‚úÖ –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞: {score}</b>

<b>üí° –≠–∫—Å–ø–µ—Ä—Ç–Ω—ã–π —Ä–∞–∑–±–æ—Ä:</b>
{advice}
"""

    bot.send_message(msg.chat.id, result_text)


# =============================
# RUN
# =============================
print("Bot started.")
bot.infinity_polling()