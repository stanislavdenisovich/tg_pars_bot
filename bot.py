import os
import telebot
from openai import OpenAI
import json
from datetime import datetime
import math

# =============================
#  ENV VARIABLES
# =============================
TG_BOT_TOKEN = os.getenv("TG_BOT_TOKEN")
OPENAI_KEY = os.getenv("OPENAI_API_KEY")

if not TG_BOT_TOKEN:
    raise RuntimeError("TG_BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ Railway ‚Üí Variables")
if not OPENAI_KEY:
    raise RuntimeError("OPENAI_API_KEY –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ Railway ‚Üí Variables")

bot = telebot.TeleBot(TG_BOT_TOKEN, parse_mode="HTML")
client = OpenAI(api_key=OPENAI_KEY)


# =============================
# /start
# =============================
@bot.message_handler(commands=["start"])
def start(msg):
    bot.send_message(
        msg.chat.id,
        "üî• –ù–∞–ø–∏—à–∏ —Å–≤–æ—é –∏–¥–µ—é —Å—Ç–∞—Ä—Ç–∞–ø–∞ –≤ –ª—é–±–æ–º —Ñ–æ—Ä–º–∞—Ç–µ ‚Äî –ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç–æ–º.\n"
        "–Ø —Å–∞–º –∏–∑–≤–ª–µ–∫—É –∫–ª—é—á–µ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏ –æ—Ü–µ–Ω—é –µ—ë –ø–æ –º–æ–¥–µ–ª–∏ RICE+ —Å —É—á—ë—Ç–æ–º —Ä–µ–∞–ª–∏–π –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞."
    )


# =============================
# ChatGPT ‚Äî RICE+ –∞–Ω–∞–ª–∏–∑ –±–µ–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
# =============================
def ask_chatgpt(idea_text):
    """
    GPT —Å–∞–º –∏–∑–≤–ª–µ–∫–∞–µ—Ç:
    - –ø—Ä–æ–±–ª–µ–º—É
    - –¶–ê
    - —Ä–∞–∑–º–µ—Ä –∞—É–¥–∏—Ç–æ—Ä–∏–∏
    - –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
    - —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å
    - —Å–ª–æ–∂–Ω–æ—Å—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
    –ò –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —á–∏—Å—Ç—ã–π JSON —Å 5 –º–µ—Ç—Ä–∏–∫–∞–º–∏.
    """

    rules = """
–¢—ã ‚Äî —Å—Ç–∞—Ä—à–∏–π –ø—Ä–æ–¥—É–∫—Ç–æ–≤—ã–π –∞–Ω–∞–ª–∏—Ç–∏–∫, —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Å—Ç–∞—Ä—Ç–∞–ø–∞–º –∏ —Ä—ã–Ω–∫–∞–º –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–π –ê–∑–∏–∏. 
–¢–µ–±–µ –¥–∞—é—Ç –∏–¥–µ—é —Å—Ç–∞—Ä—Ç–∞–ø–∞ –≤ –ª—é–±–æ–º —Ñ–æ—Ä–º–∞—Ç–µ: –∫–æ—Ä–æ—Ç–∫–æ, –¥–ª–∏–Ω–Ω–æ, –Ω–µ–ø–æ–ª–Ω–æ, –±–µ—Å—Å–∏—Å—Ç–µ–º–Ω–æ, —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω–æ, –¥–∞–∂–µ –≤ –≤–∏–¥–µ –ø–æ—Ç–æ–∫–∞ –º—ã—Å–ª–µ–π.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞—Ç—å –µ—ë –∏ –≤—ã–≤–µ—Å—Ç–∏ —Ç–æ—á–Ω—ã–µ —á–∏—Å–ª–µ–Ω–Ω—ã–µ –æ—Ü–µ–Ω–∫–∏ –ø–æ –º–æ–¥–µ–ª–∏ RICE+Competition
—Å —É—á—ë—Ç–æ–º —Ä–µ–∞–ª–∏–π –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞ –∏ –æ—Å–æ–±–µ–Ω–Ω–æ –ê–ª–º–∞—Ç—ã.

----------------------------------------------------------------------
–û–ë–©–ò–ï –ü–†–ê–í–ò–õ–ê –ê–ù–ê–õ–ò–ó–ê
----------------------------------------------------------------------
1) –í—Å–µ–≥–¥–∞ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∏–¥–µ—é —Å—Ç—Ä–æ–≥–æ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞:
   ‚Ä¢ –≤—ã—Å–æ–∫–∞—è –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π –≤ –ê–ª–º–∞—Ç—ã  
   ‚Ä¢ —Å–∏–ª—å–Ω–æ–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ Kaspi, Choco, –Ø–Ω–¥–µ–∫—Å, Glovo  
   ‚Ä¢ –ª–æ–≥–∏—Å—Ç–∏–∫–∞ —Ä–∞–∑–≤–∏—Ç–∞ –Ω–µ—Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ (–ê–ª–º–∞—Ç—ã >> —Ä–µ–≥–∏–æ–Ω—ã)  
   ‚Ä¢ —Å—Ä–µ–¥–Ω–∏–π —á–µ–∫ –∏ –ø–æ–∫—É–ø–∞—Ç–µ–ª—å–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –Ω–∏–∂–µ, —á–µ–º –≤ –°–®–ê/–ï–≤—Ä–æ–ø–µ  
   ‚Ä¢ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞—é—Ç –ø—Ä–æ—Å—Ç—ã–µ –∏ –±—ã—Å—Ç—Ä—ã–µ —Ä–µ—à–µ–Ω–∏—è  
   ‚Ä¢ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω ‚Äî –Ω–µ–±–æ–ª—å—à–æ–π —Ä—ã–Ω–æ–∫: —Å–≤–µ—Ä—Ö–º–∞—Å—à—Ç–∞–±—ã –Ω–µ–¥–æ—Å—Ç–∏–∂–∏–º—ã  

2) –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –≤ –∏–¥–µ–µ –Ω–µ–ø–æ–ª–Ω—ã–µ ‚Äî –¥–æ—Å—Ç—Ä–∞–∏–≤–∞–π –ª–æ–≥–∏—á–Ω–æ, –Ω–æ –∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω–æ.

3) –ù–∏–∫–æ–≥–¥–∞ –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π –º–∏—Ä–æ–≤—ã–µ –º–∞—Å—à—Ç–∞–±—ã.  
   –¢–æ–ª—å–∫–æ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω: 19 –º–ª–Ω –Ω–∞—Å–µ–ª–µ–Ω–∏—è, ~12 –º–ª–Ω –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

4) –í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–π –¢–û–õ–¨–ö–û JSON.  
   –ù–∏–∫–∞–∫–∏—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤, –ø–æ—è—Å–Ω–µ–Ω–∏–π, —Ç–µ–∫—Å—Ç–∞, —Ä–∞–∑–º–µ—Ç–∫–∏.

----------------------------------------------------------------------   
–ú–ï–¢–†–ò–ö–ò, –ö–û–¢–û–†–´–ï –ù–£–ñ–ù–û –í–´–í–ï–°–¢–ò
----------------------------------------------------------------------
–¢—ã –¥–æ–ª–∂–µ–Ω –≤—ã–≤–µ—Å—Ç–∏ –∑–Ω–∞—á–µ–Ω–∏—è 5 –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤:

{
  "reach": int 0..100000,
  "impact": int 1..5,
  "confidence": float 0..1,
  "effort": int 1..10,
  "competition": int 1..10
}

–ù–∏–∂–µ ‚Äî –ø—Ä–µ–¥–µ–ª—å–Ω–æ —Ç–æ—á–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –∫–∞–∂–¥–æ–π –º–µ—Ç—Ä–∏–∫–∏.

----------------------------------------------------------------------   
### 1) REACH (0..100000)
----------------------------------------------------------------------   
–ß—Ç–æ —ç—Ç–æ:
‚Ä¢ –û—Ü–µ–Ω–∫–∞ —Ç–æ–≥–æ, —Å–∫–æ–ª—å–∫–æ –ª—é–¥–µ–π –≤ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–µ –º–æ–≥—É—Ç —Ä–µ–∞–ª—å–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –ø—Ä–æ–¥—É–∫—Ç–æ–º –≤ —Ç–µ—á–µ–Ω–∏–µ 1 –º–µ—Å—è—Ü–∞.

–ö–∞–∫ —Å—á–∏—Ç–∞—Ç—å:
‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω.  
‚Ä¢ –£—á–∏—Ç—ã–≤–∞–π —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å:
  - –ê–ª–º–∞—Ç—ã ‚âà 2 –º–ª–Ω  
  - –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω ‚âà 19 –º–ª–Ω  
  - –ò–Ω—Ç–µ—Ä–Ω–µ—Ç-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ ‚âà 12 –º–ª–Ω  
  - –£—Ä–æ–≤–µ–Ω—å –ø–ª–∞—Ç–µ–∂–µ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ ‚Äî —Å—Ä–µ–¥–Ω–∏–π  

–¢–∏–ø–æ–≤—ã–µ —É—Ä–æ–≤–Ω–∏ —Ä—ã–Ω–∫–∞:
‚Ä¢ 0‚Äì1000     ‚Üí —É–ª—å—Ç—Ä–∞-–Ω–∏—à–∞, —É–∑–∫–∞—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞  
‚Ä¢ 1000‚Äì10000 ‚Üí –Ω–∏—à–∞ –≤–Ω—É—Ç—Ä–∏ –ê–ª–º–∞—Ç—ã  
‚Ä¢ 10000‚Äì30000 ‚Üí –∫—Ä—É–ø–Ω–∞—è –Ω–∏—à–∞ –ê–ª–º–∞—Ç—ã –∏–ª–∏ –º–∞–ª–µ–Ω—å–∫–∏–π —Ä—ã–Ω–æ–∫ –ø–æ —Å—Ç—Ä–∞–Ω–µ  
‚Ä¢ 30000‚Äì60000 ‚Üí –∑–∞–º–µ—Ç–Ω—ã–π —Å–µ–≥–º–µ–Ω—Ç –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞  
‚Ä¢ 60000‚Äì100000 ‚Üí –º–∞—Å—Å–æ–≤—ã–π —Ä—ã–Ω–æ–∫ (–¥–ª—è –†–ö —ç—Ç–æ –ø–æ—Ç–æ–ª–æ–∫)

–ö–∞–∫ –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å:
‚Ä¢ –±–µ—Ä—ë—à—å –¶–ê –∏–∑ –∏–¥–µ–∏ ‚Üí –æ—Ü–µ–Ω–∏–≤–∞–µ—à—å —Ä–µ–∞–ª—å–Ω—É—é –¥–æ—Å—Ç—É–ø–Ω—É—é –∞—É–¥–∏—Ç–æ—Ä–∏—é  
‚Ä¢ –µ—Å–ª–∏ —Å–µ–≥–º–µ–Ω—Ç –Ω–µ —É–∫–∞–∑–∞–Ω ‚Äî –æ—Ü–µ–Ω–∏–≤–∞–π –º–∏–Ω–∏–º–∞–ª—å–Ω–æ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ  
‚Ä¢ –µ—Å–ª–∏ –∏–¥–µ—è –º–∞—Å—Å–æ–≤–∞—è, –Ω–æ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è –≤—ã—Å–æ–∫–∞—è ‚Üí –≤—Å—ë —Ä–∞–≤–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–π —Ä–µ–∞–ª—å–Ω—ã–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º  

----------------------------------------------------------------------   
### 2) IMPACT (1..5)
----------------------------------------------------------------------   
–ß—Ç–æ —ç—Ç–æ:
‚Ä¢ –°–∏–ª–∞ —ç—Ñ—Ñ–µ–∫—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ–¥—É–∫—Ç –ø—Ä–∏–Ω–æ—Å–∏—Ç –æ–¥–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.

–ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è:
‚Ä¢ 1 = –ª—ë–≥–∫–æ–µ —É–¥–æ–±—Å—Ç–≤–æ, –∫–æ—Å–º–µ—Ç–∏—á–µ—Å–∫–∞—è —É–ª—É—á—à–∞–ª–∫–∞  
‚Ä¢ 2 = –æ—â—É—Ç–∏–º–æ–µ, –Ω–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ–µ —É–¥–æ–±—Å—Ç–≤–æ  
‚Ä¢ 3 = —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –ø–æ–ª—å–∑–∞, –∑–∞–∫—Ä—ã–≤–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—É—é –±–æ–ª—å  
‚Ä¢ 4 = –∫—Ä–∏—Ç–∏—á–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ, –±–µ–∑ –Ω–µ–≥–æ –Ω–µ—É–¥–æ–±–Ω–æ –∂–∏—Ç—å  
‚Ä¢ 5 = —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è: —ç–∫–æ–Ω–æ–º–∏—Ç –¥–µ–Ω—å–≥–∏/–≤—Ä–µ–º—è –≤ —Ä–∞–∑—ã, —Ä–µ—à–∞–µ—Ç –æ—Å—Ç—Ä—É—é –±–æ–ª—å, –¥–∞—ë—Ç –æ–≥—Ä–æ–º–Ω—É—é —Ü–µ–Ω–Ω–æ—Å—Ç—å

----------------------------------------------------------------------   
### 3) CONFIDENCE (0..1)
----------------------------------------------------------------------   
–ß—Ç–æ —ç—Ç–æ:
‚Ä¢ –ù–∞—Å–∫–æ–ª—å–∫–æ —É–≤–µ—Ä–µ–Ω–Ω–æ –º–æ–∂–Ω–æ —Å–∫–∞–∑–∞—Ç—å, —á—Ç–æ –∏–¥–µ—è —Ä–µ–∞–ª–∏–∑—É–µ–º–∞ –∏ —Å–ø—Ä–æ—Å —Ä–µ–∞–ª—å–Ω—ã–π.

–ö–∞–∫ —Å—á–∏—Ç–∞—Ç—å:
0.1‚Äì0.3 ‚Üí –Ω–∏–∑–∫–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: –∏–¥–µ—è –Ω–µ—è—Å–Ω–∞, –¶–ê –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞, –Ω–µ—Ç –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤  
0.4‚Äì0.6 ‚Üí —Å—Ä–µ–¥–Ω—è—è: –µ—Å—Ç—å –ª–æ–≥–∏–∫–∞, –Ω–æ –º–∞–ª–æ —Ñ–∞–∫—Ç–æ–≤  
0.7‚Äì0.9 ‚Üí –≤—ã—Å–æ–∫–∞—è: –æ—á–µ–≤–∏–¥–Ω–∞—è –±–æ–ª—å, –ø–æ–Ω—è—Ç–Ω—ã–π —Ä—ã–Ω–æ–∫, —Å—É—â–µ—Å—Ç–≤—É—é—Ç –∞–Ω–∞–ª–æ–≥–∏  
1.0 ‚Äî –ø–æ—á—Ç–∏ –Ω–∏–∫–æ–≥–¥–∞, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∏–¥–µ—è —Ç—Ä–∏–≤–∏–∞–ª—å–Ω–∞—è –∏ —Ä—ã–Ω–æ–∫ –∏–∑–≤–µ—Å—Ç–Ω—ã–π

–§–∞–∫—Ç–æ—Ä—ã:
‚Ä¢ –Ω–∞—Å–∫–æ–ª—å–∫–æ —á—ë—Ç–∫–æ –æ–ø–∏—Å–∞–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞  
‚Ä¢ –µ—Å—Ç—å –ª–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã (—ç—Ç–æ ‚Üë —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å, –∞ –Ω–µ ‚Üì)  
‚Ä¢ –µ—Å—Ç—å –ª–∏ –ø—Ä–∏–º–µ—Ä—ã —É—Å–ø–µ—à–Ω—ã—Ö –∞–Ω–∞–ª–æ–≥–æ–≤  
‚Ä¢ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–µ —ç—Ç–æ–π –∏–¥–µ–µ  

----------------------------------------------------------------------   
### 4) EFFORT (1..10)
----------------------------------------------------------------------   
–ß—Ç–æ —ç—Ç–æ:
‚Ä¢ –°–ª–æ–∂–Ω–æ—Å—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ MVP (–Ω–µ –≤—Å–µ–π –∫–æ–º–ø–∞–Ω–∏–∏, —Ç–æ–ª—å–∫–æ —Å—Ç–∞—Ä—Ç–∞).

–®–∫–∞–ª–∞:
1‚Äì2 ‚Üí –ø—Ä–æ—Å—Ç–æ–π –±–æ—Ç, –ª–µ–Ω–¥–∏–Ω–≥, —Ñ–æ—Ä–º–∞  
3‚Äì4 ‚Üí –≤–µ–±-–ø—Ä–æ–¥—É–∫—Ç + –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è + 1‚Äì2 –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏  
5‚Äì6 ‚Üí –º–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –ø–ª–∞—Ç–µ–∂–∏, –ø—Ä–æ—Ñ–∏–ª–∏, CRM  
7‚Äì8 ‚Üí real-time, —Å–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞, –º–∞—à–∏–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏  
9‚Äì10 ‚Üí R&D, –±–æ–ª—å—à–∏–µ –¥–∞–Ω–Ω—ã–µ, –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏, –∫–æ–º–ø–ª–∞–µ–Ω—Å  

–£—á–∏—Ç—ã–≤–∞–π —Ä–µ–∞–ª–∏–∏ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞:
‚Ä¢ –º–∞–ª–µ–Ω—å–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã  
‚Ä¢ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–µ –±—é–¥–∂–µ—Ç—ã  
‚Ä¢ —Å–ª–æ–∂–Ω–æ—Å—Ç—å hiring  
‚Ä¢ –≤—ã—Å–æ–∫–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤  

----------------------------------------------------------------------   
### 5) COMPETITION (1..10)
----------------------------------------------------------------------   
–ß—Ç–æ —ç—Ç–æ:
‚Ä¢ –ù–∞—Å–∫–æ–ª—å–∫–æ –Ω–∞—Å—ã—â–µ–Ω —Ä—ã–Ω–æ–∫ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞–º–∏.

–®–∫–∞–ª–∞:
1‚Äì2 ‚Üí –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –Ω–µ—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤, –≥–æ–ª—É–±–æ–π –æ–∫–µ–∞–Ω  
3‚Äì5 ‚Üí —É–º–µ—Ä–µ–Ω–Ω–∞—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è  
6‚Äì8 ‚Üí –Ω–∞—Å—ã—â–µ–Ω–Ω—ã–π —Ä—ã–Ω–æ–∫, –º–Ω–æ–≥–æ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤  
9‚Äì10 ‚Üí –º–æ–Ω–æ–ø–æ–ª–∏–∏ –∏ –¥–æ–º–∏–Ω–∏—Ä—É—é—â–∏–µ –∏–≥—Ä–æ–∫–∏ (Kaspi, Choco, –Ø–Ω–¥–µ–∫—Å, Glovo)

–ö–∞–∫ —Å—á–∏—Ç–∞—Ç—å:
‚Ä¢ –µ—Å–ª–∏ –µ—Å—Ç—å –≤–Ω–µ—à–Ω–∏–µ –∞–Ω–∞–ª–æ–≥–∏ ‚Üí –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è –º–∏–Ω–∏–º—É–º 4  
‚Ä¢ –µ—Å–ª–∏ —Ä—ã–Ω–æ–∫ –æ—á–µ–≤–∏–¥–Ω—ã–π (–¥–æ—Å—Ç–∞–≤–∫–∞, e-commerce, —Ñ–∏–Ω—Ç–µ—Ö) ‚Üí 7‚Äì10  
‚Ä¢ –µ—Å–ª–∏ –Ω–∏—à–∞ –Ω–æ–≤–∞—è –∏–ª–∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è ‚Üí 1‚Äì3  

----------------------------------------------------------------------   
–§–ò–ù–ê–õ–¨–ù–û–ï –¢–†–ï–ë–û–í–ê–ù–ò–ï
----------------------------------------------------------------------
–í—ã–≤–æ–¥–∏ —Å—Ç—Ä–æ–≥–æ JSON —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤–∏–¥–∞, –±–µ–∑ —Ç–µ–∫—Å—Ç–∞:

{
  "reach": <int>,
  "impact": <int>,
  "confidence": <float>,
  "effort": <int>,
  "competition": <int>
}
"""

    user_data = f"–ò–¥–µ—è: {idea_text}\n\n–í—ã–≤–µ–¥–∏ JSON —Å—Ç—Ä–æ–≥–æ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞."

    response = client.chat.completions.create(
        model="gpt-4o-mini",
        temperature=0.1,
        messages=[
            {"role": "system", "content": rules},
            {"role": "user", "content": user_data}
        ]
    )

    raw = response.choices[0].message.content

    # –ü–∞—Ä—Å–∏–º JSON
    try:
        data = json.loads(raw)
    except:
        import re
        m = re.search(r"\{[\s\S]*\}", raw)
        if not m:
            raise RuntimeError("GPT –≤–µ—Ä–Ω—É–ª –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π JSON:\n" + raw)
        data = json.loads(m.group(0))

    # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è + —Ç–∏–ø—ã
    def clamp_int(v, lo, hi):
        try: v = int(round(float(v)))
        except: v = lo
        return max(lo, min(hi, v))

    def clamp_float(v, lo, hi, ndigits=2):
        try: v = float(v)
        except: v = lo
        return round(max(lo, min(hi, v)), ndigits)

    return {
        "reach": clamp_int(data.get("reach", 0), 0, 100000),
        "impact": clamp_int(data.get("impact", 3), 1, 5),
        "confidence": clamp_float(data.get("confidence", 0.5), 0, 1),
        "effort": clamp_int(data.get("effort", 5), 1, 10),
        "competition": clamp_int(data.get("competition", 5), 1, 10),
    }


# =============================
# SCORE formula
# =============================
def compute_score(R, I, C, E, K, alpha=0.9, beta=1.2, gamma=0.7, delta=1.8, etha=1.5):
    R_norm = math.log(1 + max(R, 0)) ** alpha
    I_w = I ** beta
    E_w = E ** delta
    K_w = K ** etha
    C_w = C ** gamma
    return round((R_norm * I_w * C_w) / (E_w * K_w), 4)


# =============================
# SAVE
# =============================
def save_result(user_id, idea, params, score):
    with open("results.txt", "a", encoding="utf-8") as f:
        f.write("\n============================\n")
        f.write(f"–î–∞—Ç–∞: {datetime.now()}\n")
        f.write(f"User ID: {user_id}\n")
        f.write(f"–ò–¥–µ—è:\n{idea}\n\n")
        f.write("RICE+ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:\n")
        f.write(json.dumps(params, ensure_ascii=False, indent=2))
        f.write(f"\nScore: {score}\n")
        f.write("============================\n")


# =============================
# MAIN HANDLER (–ü—Ä–æ—Å—Ç–æ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∏–¥–µ—é)
# =============================
@bot.message_handler(func=lambda m: True)
def handle_idea(msg):
    user = msg.from_user.id
    idea = msg.text

    bot.send_message(msg.chat.id, "‚úÖ –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Ç–≤–æ—é –∏–¥–µ—é...")

    params = ask_chatgpt(idea)
    score = compute_score(
        R=params["reach"],
        I=params["impact"],
        C=params["confidence"],
        E=params["effort"],
        K=params["competition"]
)
    save_result(user, idea, params, score)

    result_text = f"""
<b>üîç –ê–Ω–∞–ª–∏–∑ —Ç–≤–æ–µ–π –∏–¥–µ–∏</b>

<b>‚úÖ –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞: {score}</b>

<b>üìä –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:</b>
‚Ä¢ Reach: {params['reach']}
‚Ä¢ Impact: {params['impact']}
‚Ä¢ Confidence: {params['confidence']}
‚Ä¢ Effort: {params['effort']}
‚Ä¢ Competition: {params['competition']}

<b>üí° –í—ã–≤–æ–¥:</b>
{"üî• –û—Ç–ª–∏—á–Ω–∞—è –∏–¥–µ—è! –£ –Ω–µ—ë –≤—ã—Å–æ–∫–∏–π —Ä—ã–Ω–æ—á–Ω—ã–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª –≤ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–µ." if score > 0.8 else
 "‚úÖ –ù–µ–ø–ª–æ—Ö–∞—è –∏–¥–µ—è, –µ—Å—Ç—å –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã ‚Äî –Ω—É–∂–Ω–æ –¥–æ—Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ." if score > 0.4 else
 "‚ö†Ô∏è –°–ª–∞–±–∞—è –∏–¥–µ—è: –Ω–µ–±–æ–ª—å—à–æ–π —Ä—ã–Ω–æ–∫ –∏–ª–∏ —Å–ª–∏—à–∫–æ–º –≤—ã—Å–æ–∫–∞—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è."}

<b>üìå –°–æ–≤–µ—Ç:</b>
{"–ó–∞–ø—É—Å–∫–∞–π MVP –∏ –ø—Ä–æ–≤–µ—Ä—è–π —Å–ø—Ä–æ—Å –∫–∞–∫ –º–æ–∂–Ω–æ –±—ã—Å—Ç—Ä–µ–µ." if score > 0.8 else
 "–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π –≥–∏–ø–æ—Ç–µ–∑—É –Ω–∞ –Ω–µ–±–æ–ª—å—à–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏." if score > 0.4 else
 "–ü–æ–¥—É–º–∞–π –æ –Ω–æ–≤–æ–π –Ω–∏—à–µ –∏–ª–∏ —Ä–µ–∑–∫–æ–º –æ—Ç–ª–∏—á–∏–∏ –æ—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤."}
"""

    bot.send_message(msg.chat.id, result_text)


# =============================
# RUN
# =============================
print("Bot started.")
bot.infinity_polling()