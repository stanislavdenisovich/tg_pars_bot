import os
import telebot
from telebot.types import ReplyKeyboardMarkup, KeyboardButton
from openai import OpenAI
import math
import json
from datetime import datetime

# === –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ Railway ===
TG_BOT_TOKEN = os.getenv("TG_BOT_TOKEN")
OPENAI_KEY = os.getenv("OPENAI_API_KEY")

if not TG_BOT_TOKEN:
    raise RuntimeError("TG_BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω. –î–æ–±–∞–≤—å –µ–≥–æ –≤ Railway ‚Üí Variables")
if not OPENAI_KEY:
    raise RuntimeError("OPENAI_API_KEY –Ω–µ –Ω–∞–π–¥–µ–Ω. –î–æ–±–∞–≤—å –µ–≥–æ –≤ Railway ‚Üí Variables")

bot = telebot.TeleBot(TG_BOT_TOKEN, parse_mode="HTML")
client = OpenAI(api_key=OPENAI_KEY)

USER_STATE = {}
ANSWERS = {}

QUESTIONS = [
    "1) –û–ø–∏—à–∏ –ø—Ä–æ–±–ª–µ–º—É, –∫–æ—Ç–æ—Ä—É—é —Ä–µ—à–∞–µ—Ç —Ç–≤–æ—è –∏–¥–µ—è:",
    "2) –û–ø–∏—à–∏ —Å–∞–º–æ —Ä–µ—à–µ–Ω–∏–µ ‚Äî —á—Ç–æ –¥–µ–ª–∞–µ—Ç –ø—Ä–æ–¥—É–∫—Ç:",
    "3) –ö—Ç–æ —Ü–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è?",
    "4) –ù–∞—Å–∫–æ–ª—å–∫–æ –º–∞—Å—Å–æ–≤–∞—è –ø—Ä–æ–±–ª–µ–º–∞? (–≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö –∏–ª–∏ —á–∏—Å–ª–∞—Ö)",
    "5) –ù–∞—Å–∫–æ–ª—å–∫–æ —Å–∏–ª—å–Ω–æ —Ä–µ—à–µ–Ω–∏–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?"
]

# =============================
# /start
# =============================
@bot.message_handler(commands=["start"])
def start(msg):
    user = msg.from_user.id
    USER_STATE[user] = 0
    ANSWERS[user] = []

    bot.send_message(msg.chat.id,
        "üî• –ü—Ä–∏—Å—Ç—É–ø–∞–µ–º –∫ –æ—Ü–µ–Ω–∫–µ —Ç–≤–æ–µ–π –∏–¥–µ–∏.\n"
        "–û—Ç–≤–µ—á–∞–π –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã.\n\n"
        + QUESTIONS[0]
    )

# =============================
# –°–±–æ—Ä –æ—Ç–≤–µ—Ç–æ–≤
# =============================
@bot.message_handler(func=lambda m: m.from_user.id in USER_STATE)
def collect_answers(msg):
    user = msg.from_user.id
    step = USER_STATE[user]

    ANSWERS[user].append(msg.text)
    USER_STATE[user] += 1

    if USER_STATE[user] < len(QUESTIONS):
        bot.send_message(msg.chat.id, QUESTIONS[USER_STATE[user]])
    else:
        bot.send_message(msg.chat.id, "‚úÖ –û—Ç–ª–∏—á–Ω–æ. –ò–¥—É —Å—á–∏—Ç–∞—Ç—å –æ—Ü–µ–Ω–∫—É...")
        process_idea(msg.chat.id, user)

# =============================
# ChatGPT –∞–Ω–∞–ª–∏–∑
# =============================
def ask_chatgpt(answers):
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª–æ–≤–∞—Ä—å —Å —á–∏—Å–ª–æ–≤—ã–º–∏ –ø–æ–ª—è–º–∏:
    {
      "reach": int [0..100000],
      "impact": int [1..5],
      "confidence": float [0..1],
      "effort": int [1..10],
      "competition": int [1..10]
    }
    """
    rules = """
–¢—ã ‚Äî —Å—Ç—Ä–æ–≥–∏–π –æ—Ü–µ–Ω—â–∏–∫ —Å—Ç–∞—Ä—Ç–∞–ø–æ–≤ –ø–æ –º–æ–¥–µ–ª–∏ RICE+, –≤–æ–∑–≤—Ä–∞—â–∞–π –¢–û–õ–¨–ö–û JSON –±–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∏ —Ç–µ–∫—Å—Ç–∞.

–û—Ü–µ–Ω–∏ –ø–æ –ø—è—Ç–∏ –º–µ—Ç—Ä–∏–∫–∞–º —Å –ñ–Å–°–¢–ö–ò–ú–ò –¥–∏–∞–ø–∞–∑–æ–Ω–∞–º–∏ –∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏:

1) reach (R) ‚Äî –æ—Ü–µ–Ω–∫–∞ –æ—Ö–≤–∞—Ç–∞ –∞—É–¥–∏—Ç–æ—Ä–∏–∏/–∫–æ–ª-–≤–∞ –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –º–µ—Å—è—Ü.
   ‚Ä¢ –¢–∏–ø: —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ.
   ‚Ä¢ –î–∏–∞–ø–∞–∑–æ–Ω: 0..100000 (0 ‚Äî –Ω–∏–∫–æ–≥–æ, 100000 ‚Äî —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω–æ –º–∞—Å—Å–æ–≤–æ).
   ‚Ä¢ –≠–≤—Ä–∏—Å—Ç–∏–∫–∞:
     - –Ω–∏—à–∞ < 1 000
     - –º–∞–ª–µ–Ω—å–∫–∏–π —Ä—ã–Ω–æ–∫ 1 000..10 000
     - —Å—Ä–µ–¥–Ω–∏–π 10 001..30 000
     - –±–æ–ª—å—à–æ–π 30 001..60 000
     - –º–∞—Å—Å–æ–≤—ã–π 60 001..100 000
   ‚Ä¢ –û–ø–∏—Ä–∞—Ç—å—Å—è –Ω–∞ —Ä–∞–∑–º–µ—Ä –¶–ê, —à–∏—Ä–æ—Ç—É –ø—Ä–æ–±–ª–µ–º—ã, —á–∞—Å—Ç–æ—Ç—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ –¥–æ–ø—É—â–µ–Ω–∏—è.

2) impact (I) ‚Äî —Å–∏–ª–∞ —ç—Ñ—Ñ–µ–∫—Ç–∞ —Ä–µ—à–µ–Ω–∏—è –¥–ª—è –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
   ‚Ä¢ –¢–∏–ø: —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ.
   ‚Ä¢ –î–∏–∞–ø–∞–∑–æ–Ω: 1..5 (1 ‚Äî –∫–æ—Å–º–µ—Ç–∏—á–µ—Å–∫–∏, 5 ‚Äî —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ).
   ‚Ä¢ –®–∫–∞–ª–∞:
     1 = –ª—ë–≥–∫–æ–µ —É–¥–æ–±—Å—Ç–≤–æ/–∫–æ—Å–º–µ—Ç–∏–∫–∞
     2 = –∑–∞–º–µ—Ç–Ω–æ–µ —É–¥–æ–±—Å—Ç–≤–æ
     3 = —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –ø–æ–ª—å–∑–∞/—ç–∫–æ–Ω–æ–º–∏—è –≤—Ä–µ–º–µ–Ω–∏/–¥–µ–Ω–µ–≥
     4 = –∫—Ä–∏—Ç–∏—á–Ω–∞—è –ø–æ–ª—å–∑–∞, —Å–∏–ª—å–Ω–æ –º–µ–Ω—è–µ—Ç –ø–æ–≤–µ–¥–µ–Ω–∏–µ
     5 = –∂–∏–∑–Ω–µ–Ω–Ω–æ –≤–∞–∂–Ω–æ/—Å–ª–æ–º —Ä—ã–Ω–∫–∞/–∑–∞–º–µ–Ω–∞ –ø—Ä–∏–≤—ã—á–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤

3) confidence (C) ‚Äî —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ –æ—Ü–µ–Ω–∫–∞—Ö –∏ –æ—Å—É—â–µ—Å—Ç–≤–∏–º–æ—Å—Ç–∏.
   ‚Ä¢ –¢–∏–ø: —á–∏—Å–ª–æ —Å –ø–ª–∞–≤–∞—é—â–µ–π —Ç–æ—á–∫–æ–π.
   ‚Ä¢ –î–∏–∞–ø–∞–∑–æ–Ω: 0..1 (0 ‚Äî –Ω–µ—Ç —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏, 1 ‚Äî –æ—á–µ–Ω—å –≤—ã—Å–æ–∫–∞—è).
   ‚Ä¢ –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ –¥–æ –¥–≤—É—Ö –∑–Ω–∞–∫–æ–≤.
   ‚Ä¢ –û–ø–∏—Ä–∞—Ç—å—Å—è –Ω–∞ —è—Å–Ω–æ—Å—Ç—å –±–æ–ª–∏, –Ω–∞–ª–∏—á–∏–µ —Å–∏–≥–Ω–∞–ª–æ–≤ —Å–ø—Ä–æ—Å–∞, –ø—Ä–æ—Å—Ç–æ—Ç—É —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏, –∞–Ω–∞–ª–æ–≥–∏–∏/—Ä–µ—Ñ–µ—Ä–µ–Ω—Å—ã.
     –ü—Ä–∏–º–µ—Ä—ã –ø–æ—Ä–æ–≥–æ–≤:
       0.2 ‚Äî —Å–ª–∞–±—ã–µ –æ—Å–Ω–æ–≤–∞–Ω–∏—è/–º–∞–ª–æ –¥–∞–Ω–Ω—ã—Ö
       0.5 ‚Äî —Å—Ä–µ–¥–Ω—è—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å
       0.8 ‚Äî —Å–∏–ª—å–Ω–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å (–µ—Å—Ç—å —Å–∏–≥–Ω–∞–ª—ã —Ä—ã–Ω–∫–∞/–ø—Ä–æ—Ç–æ—Ç–∏–ø/–∫–µ–π—Å—ã)

4) effort (E) ‚Äî —Å–ª–æ–∂–Ω–æ—Å—Ç—å/–∑–∞—Ç—Ä–∞—Ç—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–µ—Ä–≤–æ–≥–æ —Ä–µ–ª–∏–∑–∞ (MVP‚Üív1).
   ‚Ä¢ –¢–∏–ø: —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ.
   ‚Ä¢ –î–∏–∞–ø–∞–∑–æ–Ω: 1..10 (1 ‚Äî ¬´–≤—ã—Ö–æ–¥–Ω—ã–µ –∏ –≥–æ—Ç–æ–≤–æ¬ª, 10 ‚Äî ¬´–º–Ω–æ–≥–æ–ª–µ—Ç–Ω–∏–π –ø—Ä–æ–µ–∫—Ç¬ª).
   ‚Ä¢ –≠–≤—Ä–∏—Å—Ç–∏–∫–∞:
     1‚Äì2: –ª–µ–Ω–¥–∏–Ω–≥/–ø—Ä–æ—Å—Ç–∞—è —Ñ–æ—Ä–º–∞/–ø—Ä–æ—Å—Ç–æ–µ CRUD-–≤–µ–±/–±–æ—Ç –±–µ–∑ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π
     3‚Äì4: –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –≤–µ–±-–ø—Ä–æ–¥—É–∫—Ç, 1‚Äì2 –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏, –ø—Ä–æ—Å—Ç–∞—è –∞–¥–º–∏–Ω–∫–∞
     5‚Äì6: –º–æ–±–∏–ª—å–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—ã, –ø–ª–∞—Ç—ë–∂–∫–∏, —Ä–æ–ª–∏, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞, —É–º–µ—Ä–µ–Ω–Ω—ã–π –±—ç–∫–µ–Ω–¥
     7‚Äì8: —Å–ª–æ–∂–Ω—ã–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏, real-time, ML-–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å/–∫–æ–º–ø–ª–∞–µ–Ω—Å
     9‚Äì10: –≤—ã—Å–æ–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—é, —Ä–µ–≥—É–ª—è—Ü–∏–∏, –¥–ª–∏–Ω–Ω—ã–π R&D

5) competition (K) ‚Äî —É—Ä–æ–≤–µ–Ω—å –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏ –∏ –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å —Ä—ã–Ω–∫–∞.
   ‚Ä¢ –¢–∏–ø: —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ.
   ‚Ä¢ –î–∏–∞–ø–∞–∑–æ–Ω: 1..10 (1 ‚Äî ¬´blue ocean¬ª, 10 ‚Äî ¬´red ocean¬ª —Å –¥–æ–º–∏–Ω–∞–Ω—Ç–∞–º–∏).
   ‚Ä¢ –≠–≤—Ä–∏—Å—Ç–∏–∫–∞:
     1‚Äì2: –ø–æ—á—Ç–∏ –Ω–µ—Ç –ø—Ä—è–º—ã—Ö –∞–Ω–∞–ª–æ–≥–æ–≤, –≤—ã—Å–æ–∫–∞—è –Ω–æ–≤–∏–∑–Ω–∞
     3‚Äì5: –µ—Å—Ç—å –∞–Ω–∞–ª–æ–≥–∏/SMB-–∏–≥—Ä–æ–∫–∏, –Ω–∏—à–µ–≤–∞—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è
     6‚Äì8: –∑–∞–º–µ—Ç–Ω—ã–µ –∏–≥—Ä–æ–∫–∏, –º–Ω–æ–≥–æ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤, –Ω—É–∂–µ–Ω —Å–∏–ª—å–Ω—ã–π –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞—Ç–æ—Ä
     9‚Äì10: –∫—Ä—É–ø–Ω—ã–µ –¥–æ–º–∏–Ω–∞–Ω—Ç—ã, –≤—ã—Å–æ–∫–∏–µ switching costs, —Å–∏–ª—å–Ω—ã–µ —Å–µ—Ç–∏/–º–æ–∞—Ç—ã

–û–ë–©–ò–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø:
‚Ä¢ –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –º–∞–ª–æ ‚Äî –æ—Ü–µ–Ω–∏ –∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω–æ, –Ω–æ –≤ –∑–∞–¥–∞–Ω–Ω—ã—Ö –¥–∏–∞–ø–∞–∑–æ–Ω–∞—Ö.
‚Ä¢ –°–æ–±–ª—é–¥–∞–π —Ç–∏–ø—ã: reach/impact/effort/competition ‚Äî —Ü–µ–ª—ã–µ; confidence ‚Äî float —Å 2 –∑–Ω–∞–∫–∞–º–∏.
‚Ä¢ –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–π JSON –±–µ–∑ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É—é—â–µ–≥–æ —Ç–µ–∫—Å—Ç–∞.
"""

    user_data = f"""
–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
1) –ü—Ä–æ–±–ª–µ–º–∞: {answers[0]}
2) –†–µ—à–µ–Ω–∏–µ: {answers[1]}
3) –ê—É–¥–∏—Ç–æ—Ä–∏—è: {answers[2]}
4) –ú–∞—Å—à—Ç–∞–±: {answers[3]}
5) –≠—Ñ—Ñ–µ–∫—Ç: {answers[4]}

–í–µ—Ä–Ω–∏ JSON —Å—Ç—Ä–æ–≥–æ —Ç–∞–∫–æ–≥–æ –≤–∏–¥–∞ (–∫–ª—é—á–∏ –∏ —Ç–∏–ø—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã):
{{
  "reach": <int 0..100000>,
  "impact": <int 1..5>,
  "confidence": <float 0..1>,
  "effort": <int 1..10>,
  "competition": <int 1..10>
}}
"""

    response = client.chat.completions.create(
        model="gpt-4o-mini",
        temperature=0.2,
        messages=[
            {"role": "system", "content": rules.strip()},
            {"role": "user", "content": user_data.strip()}
        ]
    )

    text = response.choices[0].message.content if hasattr(response.choices[0].message, "content") \
           else response.choices[0].message["content"]

    # –ñ—ë—Å—Ç–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è/–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è JSON:
    try:
        data = json.loads(text)
    except Exception:
        # –ü–æ–ø—ã—Ç–∫–∞ –≤—ã—Ç–∞—â–∏—Ç—å JSON –ø–æ –≥—Ä—É–±–æ–º—É —à–∞–±–ª–æ–Ω—É, –µ—Å–ª–∏ –º–æ–¥–µ–ª—å –≤–¥—Ä—É–≥ –¥–æ–±–∞–≤–∏–ª–∞ –ª–∏—à–Ω–µ–µ
        import re
        m = re.search(r"\{[\s\S]*\}", text)
        if not m:
            raise RuntimeError("ChatGPT –≤–µ—Ä–Ω—É–ª –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π JSON:\n" + text)
        data = json.loads(m.group(0))

    # –ü—Ä–∏–≤–µ–¥–µ–Ω–∏–µ —Ç–∏–ø–æ–≤ –∏ –∑–∞–∂–∏–º –≤ –¥–∏–∞–ø–∞–∑–æ–Ω—ã:
    def clamp_int(v, lo, hi):
        try:
            v = int(round(float(v)))
        except Exception:
            v = lo
        return max(lo, min(hi, v))

    def clamp_float(v, lo, hi, ndigits=2):
        try:
            v = float(v)
        except Exception:
            v = lo
        v = max(lo, min(hi, v))
        return round(v, ndigits)

    data_norm = {
        "reach": clamp_int(data.get("reach", 0), 0, 100000),
        "impact": clamp_int(data.get("impact", 3), 1, 5),
        "confidence": clamp_float(data.get("confidence", 0.5), 0.0, 1.0, 2),
        "effort": clamp_int(data.get("effort", 5), 1, 10),
        "competition": clamp_int(data.get("competition", 5), 1, 10),
    }

    return data_norm

# =============================
# SCORE
# =============================
def compute_score(R, I, C, E, K, alpha=0.9, beta=1.2, gamma=0.7, delta=1.8, etha=1.5):
    import math
    R_norm = math.log(1 + max(R, 0)) ** alpha
    I_w = I ** beta
    E_w = E ** delta
    K_w = K ** etha
    C_w = C ** gamma

    return round((R_norm * I_w * C_w) / (E_w * K_w), 4)

# =============================
# Save to file
# =============================
def save_result(user_id, answers, params, score):
    with open("results.txt", "a", encoding="utf-8") as f:
        f.write("\n============================\n")
        f.write(f"–î–∞—Ç–∞: {datetime.now()}\n")
        f.write(f"User ID: {user_id}\n")
        f.write("–û–ø–∏—Å–∞–Ω–∏–µ –∏–¥–µ–∏:\n")
        for a in answers:
            f.write(f" - {a}\n")
        f.write("\n–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:\n")
        for k, v in params.items():
            f.write(f"{k}: {v}\n")
        f.write(f"\nScore: {score}\n")
        f.write("============================\n")

# =============================
# Process
# =============================
def process_idea(chat_id, user):
    answers = ANSWERS[user]

    params = ask_chatgpt(answers)
    score = compute_score(
        R=params["reach"],
        I=params["impact"],
        C=params["confidence"],
        E=params["effort"],
        K=params["competition"]
    )

    save_result(user, answers, params, score)

    bot.send_message(chat_id,
        f"‚úÖ –ì–æ—Ç–æ–≤–æ!\n\n"
        f"<b>–û—Ü–µ–Ω–∫–∞ –∏–¥–µ–∏: {score}</b>\n\n"
        f"<pre>{json.dumps(params, indent=2, ensure_ascii=False)}</pre>"
    )

    del USER_STATE[user]
    del ANSWERS[user]

# =============================
# RUN
# =============================
print("Bot started.")
bot.infinity_polling()